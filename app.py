import streamlit as st
import pandas as pd
import google.generativeai as genai

# 1. ุฅุนุฏุงุฏ ุงูู API Key ูู ุงูู Secrets
if "api_key" in st.secrets:
    genai.configure(api_key=st.secrets["api_key"])
else:
    st.error("โ๏ธ ูู ูุถูู ุถููู ุงูู api_key ูู ุฅุนุฏุงุฏุงุช Secrets ุนูู Streamlit Cloud")

st.set_page_config(page_title="ูุฏุจุฑุฉ ุฑูุถุงู ุงูุฐููุฉ", layout="wide")
st.title("๐ ุฏููู ูุฏุจุฑุฉ ุฑูุถุงู ุงูุฐูู")
st.subheader("ุชุฎุทูุท ูุฌุจุงุช ูุฎุตุต ุจูุงุกู ุนูู ุงูุญุงูุฉ ุงูุตุญูุฉ ููู ูุฑุฏ")

try:
    # 2. ุชุญููู ุงูุจูุงูุงุช ูู ุงููููุงุช ุงููู ุฑูุนูุงูุง
    @st.cache_data
    def load_all_data():
        health_info = pd.read_csv("table1.csv")
        meals_data = pd.read_csv("meals.csv")
        return health_info, meals_data

    df_health, df_meals = load_all_data()
    st.success("โ ุชู ุชุญููู ุฌุฏุงูู ุงูุตุญุฉ ูุงูุฃููุงุช ุจูุฌุงุญ!")

    # 3. ูุงุฌูุฉ ุฅุฏุฎุงู ุนุฏุฏ ุงูุฃูุฑุงุฏ
    num_people = st.number_input("ูู ุนุฏุฏ ุฃูุฑุงุฏ ุงูุฃุณุฑุฉุ", min_value=1, max_value=20, value=3)

    # 4. ูุงุฌูุฉ ุฅุฏุฎุงู ุฃุณูุงุก ุงูุฃูุฑุงุฏ ูุญุงูุงุชูู ุงูุตุญูุฉ
    st.write("---")
    st.write("### ุจูุงูุงุช ุฃูุฑุงุฏ ุงูุฃุณุฑุฉ:")
    family_members = []
    
    # ุนูู ุชูุณูู ููุดุงุดุฉ ุนุดุงู ุงูุฃุณูุงุก ุชุธูุฑ ุจุดูู ููุธู
    for i in range(int(num_people)):
        cols = st.columns(2)
        with cols[0]:
            name = st.text_input(f"ุงุณู ุงููุฑุฏ {i+1}", key=f"name_{i}", placeholder="ูุซูุงู: ูุญูุฏ")
        with cols[1]:
            # ููุง ุจูุฎูู ุงูุงุฎุชูุงุฑุงุช ุชูุฌู ูุจุงุดุฑุฉ ูู ุนููุฏ 'ุงูุญุงูุฉ' ูู ุฌุฏูู table1.csv
            health_status = st.selectbox(
                f"ุงูุญุงูุฉ ุงูุตุญูุฉ ูู {name if name else f'ุงููุฑุฏ {i+1}'}", 
                options=df_health['ุงูุญุงูุฉ'].unique(),
                key=f"health_{i}"
            )
        family_members.append({"ุงูุงุณู": name, "ุงูุญุงูุฉ": health_status})

    st.write("---")

    # 5. ุฒุฑ ุชูููุฏ ุงูุฎุทุฉ
    if st.button("๐ ุชูููุฏ ุฎุทุฉ ุงููุฌุจุงุช ุงูุตุญูุฉ ููููู"):
        with st.spinner("ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูุชุญุถูุฑ ุฃูุถู ุงููููููุงุช..."):
            # ุชุญุฏูุฏ ุงูููุฏูู (ุชู ุฅุตูุงุญ ุงูุงุณู ููุชูุงูู ูุน v1beta)
            model = genai.GenerativeModel('models/gemini-1.5-flash')
            
            # ุชุฌููุฒ ุงูุทูุจ (Prompt) ุงููู ููุฑูุญ ููุฐูุงุก ุงูุงุตุทูุงุนู
            prompt = f"""
            ุฃูุช ุฎุจูุฑ ุชุบุฐูุฉ ุฑูุถุงูู. ุจูุงุกู ุนูู ุงูุฌุฏุงูู ุงูุชุงููุฉ:
            1. ุฌุฏูู ุงูุญุงูุงุช ุงูุตุญูุฉ: {df_health.to_string()}
            2. ุฌุฏูู ุงูุฃููุงุช ุงููุชุงุญุฉ: {df_meals.head(20).to_string()}
            
            ุงููุทููุจ: ุงูุชุฑุงุญ ูุฌุจุฉ ุฅูุทุงุฑ ูุณุญูุฑ ููุฃุณุฑุฉ ุงูููููุฉ ูู {num_people} ุฃูุฑุงุฏ ููู:
            {family_members}
            
            ูุฌุจ ูุฑุงุนุงุฉ:
            - ุฃู ุชูุงุณุจ ุงููุฌุจุงุช ุงูุญุงูุฉ ุงูุตุญูุฉ ููู ูุฑุฏ ุงููุฐููุฑุฉ ุฃูุงู ุงุณูู.
            - ุฐูุฑ ูุตูุญุฉ ุณุฑูุนุฉ ููู ูุฑุฏ ุจูุงุกู ุนูู ุญุงูุชู ุงูุตุญูุฉ ุงููุฐููุฑุฉ ูู ุฌุฏูู ุงูุตุญุฉ.
            - ุญุณุงุจ ุงููููุงุช ุงูุชูุฑูุจูุฉ ุจูุงุกู ุนูู ุนุฏุฏ ุงูุฃูุฑุงุฏ.
            - ุฃู ูููู ุงูุฃุณููุจ ูุดุฌุนุงู ูุฑูุถุงููุงู.
            """
            
            response = model.generate_content(prompt)
            
            # ุนุฑุถ ุงููุชูุฌุฉ
            st.markdown("### ๐ ููุชุฑุญ ุงููุฌุจุงุช ูุงููุตุงุฆุญ ุงูุตุญูุฉ:")
            st.write(response.text)

except Exception as e:
    st.error(f"โ ุญุฏุซ ุฎุทุฃ: {e}")
    st.info("ุชุฃูุฏู ุฃู ูููุงุช table1.csv ู meals.csv ููุฌูุฏุฉ ูู GitHub ุจููุณ ุงูุญุฑูู ุงูุตุบูุฑุฉ.")
